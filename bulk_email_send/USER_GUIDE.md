# 一括メール送信ツール - 使い方ガイド

## 概要

一括メール送信ツールは、NetSuite の Saved Search に基づいて、複数の受信者にメールを一括送信できるツールです。Email Template を使用し、File Cabinet からファイルを添付することができます。

### 主な特徴

- **大量送信対応**: 外部SMTPサーバー(Kagoya)経由で送信するため、受信者数の制限がありません
- **BCC送信**: 受信者は他の受信者のアドレスを見ることができません（45名ずつ分割送信）
- **HTMLメール対応**: Email TemplateのHTMLが正しくレンダリングされます
- **添付ファイル対応**: PDF、Excel、画像ファイルなどを添付できます

---

## アクセス方法

1. NetSuite にログイン
2. https://5093054.app.netsuite.com/app/site/hosting/scriptlet.nl?script=2460&deploy=1 から一括メール送信フォームにアクセス
3. または、グローバル検索で「Bulk Email」を検索

---

## 使い方（ステップ・バイ・ステップ）

### 1. Email Template（メールテンプレート）を選択
- テンプレートは **Documents > Templates > Email Templates** で作成します
- 使用したいメールテンプレートを選択します
- テンプレートにはメールの件名と本文が含まれています

### 2. Saved Search（送信先）を選択
- 送信先のリストが含まれる Saved Search を作成・選択します
- **重要**: Saved Search には **Email** 列が含まれている必要があります
- リストは更新日順にソートされています（最新のものが上に表示されます）
- 自分が作成した Saved Search のみが表示されます

### 3. Sender Name (Display Name)（送信者名）を入力
- 受信者のメールボックスに表示される送信者名です
- デフォルトは `TOKYO FOOD Co., LTD` です
- 必要に応じて変更できます（例：部署名、担当者名など）
- **注意**: 実際のメール送信元アドレスは `no-reply@tokyofood.co.nz` です

### 4. Employee (for Reply-To)（返信先従業員）を選択
- 返信先メールアドレスの取得元となる従業員を選択します
- デフォルトでは、現在ログインしているユーザー（あなた）が選択されています
- 選択した従業員のメールアドレスが、Reply-To Addressフィールドに**自動入力**されます

### 5. Reply-To Address（返信先アドレス）を入力（必須）
- 返信が送られる先のメールアドレスです
- 選択した従業員のメールアドレスが**自動入力**されます
- 必要に応じて別のメールアドレスに変更できます
- **重要**: 送信完了後、このアドレスに確認用のメールコピーが1通送信されます

### 6. Attachments（添付ファイル）を選択（任意）
- File Cabinet の **E-Mail Attachments** フォルダからファイルを選択します
- Ctrl（Windows）または Cmd（Mac）を押しながらクリックすると複数選択できます
- 選択したすべてのファイルが各メールに添付されます

### 7. Subject Override（件名の上書き）（任意）
- 空欄のままにすると、Email Template の件名が使用されます
- ここに入力すると、今回の送信に限りテンプレートの件名を上書きできます

---

## 送信先のプレビュー

送信前に、受信者リストをプレビューできます：

1. Saved Search を選択
2. **Preview Recipients** ボタンをクリック
3. Preview タブに最大100件のメールアドレスが表示されます
4. リストを確認し、正しいことを確かめてください

---

## メールの送信

1. すべての必須フィールド（赤いアスタリスク * 付き）に入力
2. **Preview Recipients** をクリックして受信者リストを確認（推奨）
3. **Send Emails** ボタンをクリック
4. 確認ダイアログで確認
5. 確認画面が表示されます：
   - **Task ID**: サポートに連絡する際に必要な番号です
   - **Started at**: タスクが開始された日時
   - **Reply-To Address**: 確認メールの送信先

### 送信後

- メールはバックグラウンドで送信されます（待つ必要はありません）
- 受信者数によって、処理に数分かかる場合があります
- ブラウザを閉じても大丈夫です - メール送信は継続されます
- **全ての送信完了後、Reply-To Addressに確認用のメールコピーが1通送信されます**
- 確認メールが届いたら、全受信者への送信処理が完了したことを意味します
- 確認メールが届かない場合は、https://vap.tokyofood.co.nz/nsmail/send のステータスを確認してください（"ok"と表示されるはずです）
- 問題が発生した場合は、**Task ID** を控えて管理者に連絡してください

---

## 重要な注意事項

### メール送信の仕組み

- メールは外部SMTPサーバー（mss52.kagoya.net）経由で `no-reply@tokyofood.co.nz` から送信されます
- 受信者には選択した送信元の名前が表示されますが、返信は Reply-To アドレスに送られます
- 送信前に Reply-To アドレスが正しいことを確認してください
- **BCC送信**: 受信者は他の受信者のアドレスを見ることができません
- **45名ずつ分割送信**: 大量送信でも安定して配信されます

### 受信者数の制限

- 外部SMTPサーバーを使用しているため、NetSuiteのメール制限の影響を受けません
- 100人単位での送信も可能ですが、大量送信の場合は事前に管理者にご相談ください

### ベストプラクティス

1. **必ずプレビューする** - 送信前に受信者リストを確認
2. **最初はテスト送信** - 小規模な Saved Search（例：自分だけ）でメールの見た目を確認
3. **Reply-To を再確認** - 返信先アドレスが正しいことを確認
4. **添付ファイルを確認** - 送信前に正しいファイルが選択されているか確認
5. **Saved Search に分かりやすい名前を付ける** - 後で見つけやすくなります

---

## トラブルシューティング

### 「必須項目が入力されていません」エラー
- Email Template、Saved Search、Sender Name、Employee、Reply-To がすべて入力されているか確認してください

### Reply-To フィールドが空のまま
- 別の Employee を選択してから、元の選択肢に戻してみてください
- フィールドに自動入力されるはずです

### Saved Search リストが空
- Saved Search を作成していない可能性があります
- 先に Saved Search を作成してください（Reports > Saved Searches > New）
- 検索に Email 列が含まれていることを確認してください

### 添付ファイルが表示されない
- ファイルは **E-Mail Attachments** フォルダ（フォルダ ID: 1280787）に入っている必要があります
- 管理者にファイルをこのフォルダに移動してもらうよう依頼してください

### メールが届かない
- まず、Reply-To Addressに確認メールが届いているか確認してください
- 確認メールが届いていれば、送信処理は正常に完了しています
- 受信者の迷惑メール/スパムフォルダを確認してください
- Saved Search に有効なメールアドレスが含まれているか確認してください
- 確認メールも届かない場合は、https://vap.tokyofood.co.nz/nsmail/send にアクセスして、ステータスが "ok" か確認してください
- 確認画面の Task ID を控えて、管理者に連絡してください

---

## 困ったときは

問題が発生した場合：

1. 確認画面の **Task ID** を控える（表示されている場合）
2. エラーメッセージのスクリーンショットを撮る
3. NetSuite 管理者に以下の情報を伝えて連絡：
   - 何をしようとしていたか
   - エラーメッセージまたは予期しない動作
   - Task ID（ある場合）
   - 使用していた Saved Search の名前

---

## 管理者向け: ファイルの更新方法

スクリプトの更新が必要な場合：

1. **Documents > Files > File Cabinet** に移動
2. **SuiteScripts > TFC SuiteScript > release > BulkEmailSender** に移動
3. 以下のファイルを更新版に置き換えます：
   - `bulk_email_form_sl.js`（メインフォームスクリプト）
   - `bulk_email_form_cs.js`（クライアント側バリデーション）
   - `bulk_email_send_mr.js`（メール送信スクリプト）
4. 追加のデプロイ手順は不要です - 変更は即座に反映されます
5. ユーザーはブラウザを更新（Ctrl+Shift+R）する必要がある場合があります

---

## クイックリファレンス

| フィールド | 必須？ | 説明 |
|-------|--------|------|
| Email Template | ✓ | 件名と本文を含むテンプレート |
| Saved Search (Recipients) | ✓ | メール送信先のリスト |
| Sender Name (Display Name) | ✓ | 受信者に表示される送信者名 |
| Employee (for Reply-To) | ✓ | 返信先アドレス取得元の従業員 |
| Reply-To Address | ✓ | 返信の送信先（確認メールもここに送られます） |
| Attachments | - | メールに添付するファイル |
| Subject Override | - | テンプレートの件名を上書き |

**主要なボタン:**
- **Preview Recipients**: 送信前にメールリストを表示
- **Send Emails**: 一括送信を開始
- **Reset**: すべてのフィールドをクリアして最初からやり直す

---

---

## システムアーキテクチャ（管理者向け）

```
NetSuite Suiteletフォーム
  ↓ ユーザー入力
NetSuite Map/Reduceスクリプト
  ↓ HTTPS POST (JSON)
外部API（Tomcat Servlet）
  https://vap.tokyofood.co.nz/nsmail/send
  ↓ JavaMail API
SMTPサーバー（mss52.kagoya.net）
  ↓ BCC 45名ずつ
受信者
```

---

*最終更新日: 2025年11月2日 - バージョン 2.0 (外部SMTP API版)*
